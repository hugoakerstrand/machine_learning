---
title: "Machine learning and facs gating: Cells (FSC-H vs SSC-H)"
author: "Hugo Akerstrand"
date: "2024-12-09"
output: 
  html_document: 
    keep_md: true
---

## Welcome!

This is a document that aims to explore different ways of gating flow cytometry
data in R, primarily using a tidymodels approach.

To do this, I am using the data set `GvHD` from `flowCore`. Note that I am not 
compensating or cleaning the data, since this is not meant to represent a complete
flow cytometry analysis pipeline.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dbscan)
library(flowCore)
library(tidyverse)
library(patchwork)
library(tidymodels)
library(ggridges)
data("GvHD")
```

Start by loading the data and make it into a tibble with the relevant list columns:

```{r, echo = TRUE}

gvhd_tibble <- tibble(
  exprs = purrr::map(GvHD, ~ exprs(.x)),                       # This contains detector information
  keywords = purrr::map(GvHD, ~ keyword(.x)),                  # This contains meta data
  exprs_tibble = purrr::map(exprs, function(.x) as_tibble(.x)) # This is for plotting
)

head(gvhd_tibble)
```

We will gate the 'cell gate' using `FSC-H` and `SSC-H` columns. First inspect the data:

```{r, echo = TRUE}
plot_list <- gvhd_tibble$exprs_tibble |> purrr::map(function(.x) {
      ggplot(data= .x, aes(x = `FSC-H`, y = `SSC-H`)) +
        geom_hex()
    }
  )

wrap_plots(plot_list[1:4])
```

We clean up the data by filtering on `FSC-H` and `SSC-H`:

```{r, echo=TRUE}
gvhd_tibble <- gvhd_tibble |> 
  mutate(exprs_tibble = purrr::map(gvhd_tibble$exprs_tibble, ~ filter(.x, `FSC-H` > 99 & `FSC-H` < 1000 & `SSC-H` < 1000)))

plot_list <- gvhd_tibble$exprs_tibble |> purrr::map(function(.x) {
      ggplot(data= .x, aes(x = `FSC-H`, y = `SSC-H`)) +
        geom_hex() +
    scale_x_continuous(limits = c(0,1000))
    }
  )

wrap_plots(plot_list[1:4])
  
```

Use the cleaned data for making training and testing sets:

```{r, echo=TRUE}
gvhd_tibble <- gvhd_tibble |> mutate(
  initial_split = purrr::map(exprs_tibble, ~ initial_split(.x, strata = `FSC-H`, prop = 0.8)),
  training = purrr::map(initial_split, ~ training(.x)),
  test = purrr::map(initial_split, ~ testing(.x))
)

plot_list <- gvhd_tibble$training |> purrr::map(function(.x) {
      ggplot(data= .x, aes(x = `FSC-H`, y = `SSC-H`)) +
        geom_hex() +
    scale_x_continuous(limits = c(0,1000))
    }
  )

wrap_plots(plot_list[1:4])
```

Now we have a look at the recorded marker expression:

```{r, echo=TRUE}
plot_list <- gvhd_tibble$exprs_tibble |> purrr::map(function(.x) {
  .x |> 
    pivot_longer(where(is.numeric)) |>
    ggplot(aes(x = log10(value + 1), y = name)) +
      ggridges::geom_density_ridges() 
    }
  )

wrap_plots(plot_list[1:4])

```

It looks like FL2-A is a clearly separated population, which we can use for 
semi-supervised clustering:

```{r, echo=TRUE}
fl2a_positive <- gvhd_tibble$exprs_tibble |> 
  purrr:::map(function(.x) if_else(log10(.x$`FL2-A` + 1) > 1, 1, 0))
```
## Clustering
We will try three different methods for gating the FSC-H vs SSC-H
1) `dbscan`
2) `Mclust`
3) semi-supervised clustering and random forest

### `dbscan`

```{r, echo=TRUE}
dbscan_recipe <- gvhd_tibble$exprs_tibble[[1]] |> 
  select(`FSC-H`, `SSC-H`)
  purrr:::map(function(.x) recipe(~ `FSC-H` + `SSC-H`, data = .x) |> step_scale(all_predictors()) |> step_log(all_predictors())) 
```

```{r, echo=TRUE}
dbscan_prep <- dbscan_recipe[1:(length(dbscan_recipe))] |> purrr:::map(function(.x) prep(.x))
  
dbscan_bake <- dbscan_prep |> map(function(.x) bake(.x, new_data = NULL))
```

```{r, echo=TRUE}
dbscan::kNNdistplot(dbscan_bake[[1]], k = 3)
abline(h = 0.15, col = "red")

```

```{r, echo=TRUE}
dbscan_result <- dbscan_bake |> map(function(.x) dbscan::dbscan(.x, eps = 0.15, minPts = 3))
```

```{r, echo=TRUE}
gvhd_tibble <- gvhd_tibble |> 
  mutate(training = map2(.x = dbscan_result, .y = dbscan_bake, .f = function(.x, .y) augment(.x, .y)))
```

```{r, echo=TRUE}
map(dbscan_result, function(.x) dbscan::tidy(.x)) |> head()
```

```{r, echo=TRUE}
plot_list <- gvhd_tibble$training |> purrr::map(function(.x) {
      ggplot(data= .x, aes(x = `FSC-H`, y = `SSC-H`, color = .cluster)) +
      geom_point() 
    }
  )

wrap_plots(plot_list[5:10])
  
```
### `mclust`

```{r, echo=TRUE}
mclust_recipe <- gvhd_tibble$training |> 
  purrr:::map(function(.x) recipe(~ `FSC-H` + `SSC-H`, data = .x) |> step_BoxCox()) 
```

```{r, echo=TRUE}
mclust_prep <- mclust_recipe[1:(length(mclust_recipe))] |> purrr:::map(function(.x) prep(.x))

mclust_bake <- mclust_prep |> map(function(.x) bake(.x, new_data = NULL))
```

```{r, echo=FALSE}
mclust_result <- mclust_bake |> map(function(.x) mclust:::Mclust(.x, G = c(2:4)))
```

```{r,echo=TRUE}
gvhd_tibble <- gvhd_tibble |> 
  mutate(training = map2(.x = mclust_result, .y = mclust_bake, .f = function(.x, .y) augment(.x, .y)))
```

```{r, echo=TRUE}
plot_list <- gvhd_tibble$training |> purrr::map(function(.x) {
      ggplot(data= .x, aes(x = `FSC-H`, y = `SSC-H`, color = .class)) +
      geom_point() 
    }
  )

wrap_plots(plot_list[1:4])
  
```

## Semi-supervised

```{r, echo = TRUE}
plot_list <- gvhd_tibble$exprs_tibble |> purrr::map(function(.x) {
    .x |> 
   dplyr::filter(`FL2-A` > 300 ) |> 
   ggplot(aes(x = `FSC-H`, y = `SSC-H`)) +
        geom_hex()
    }
  )

wrap_plots(plot_list[1:4])
```